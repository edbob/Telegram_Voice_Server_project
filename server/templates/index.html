<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
    }

    .msg {
        border: 2px solid;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .date {
        font-size: 0.9em;
        color: #666;
    }

    #autoplay-toggle {
        background-color: #4CAF50; /* –∑–µ–ª—ë–Ω—ã–π –∫–∞–∫ –≤–∫–ª—é—á–µ–Ω–æ */
        color: white;
        border: none;
        padding: 10px 18px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 15px;
        transition: background-color 0.3s ease;
    }

    #autoplay-toggle:hover {
        background-color: #45a049;
    }

    #autoplay-toggle.off {
        background-color: #f44336; /* –∫—Ä–∞—Å–Ω—ã–π –∫–∞–∫ –≤—ã–∫–ª—é—á–µ–Ω–æ */
    }

    #autoplay-toggle.off:hover {
        background-color: #d32f2f;
    }
</style>

</head>
<body>
    <h1>üó£Ô∏è –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h1>
    <button id="autoplay-toggle">üîä –ê–≤—Ç–æ–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ: –í–ö–õ</button>
    <div id="messages"></div>

<script>
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
    function isAutoplayEnabled() {
        return localStorage.getItem('autoplayEnabled') !== 'false'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
    }

    function toggleAutoplay() {
        const current = isAutoplayEnabled();
        localStorage.setItem('autoplayEnabled', (!current).toString());
        updateAutoplayButton();
    }

    function updateAutoplayButton() {
    const btn = document.getElementById('autoplay-toggle');
    const enabled = isAutoplayEnabled();
    btn.textContent = enabled
        ? 'üîä –ê–≤—Ç–æ–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ: –í–ö–õ'
        : 'üîá –ê–≤—Ç–æ–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ: –í–´–ö–õ';

        // –î–æ–±–∞–≤–∏–º/—É–¥–∞–ª–∏–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–µ–π
        if (enabled) {
            btn.classList.remove('off');
        } else {
            btn.classList.add('off');
        }
    }
    // –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
    function getReadMessages() {
        const stored = localStorage.getItem('readMessages');
        return stored ? JSON.parse(stored) : [];
    }

    function markAsRead(filename) {
        const read = getReadMessages();
        if (!read.includes(filename)) {
            read.push(filename);
            localStorage.setItem('readMessages', JSON.stringify(read));
        }
    }

    async function fetchMessages() {
        const res = await fetch('/api/messages');
        const data = await res.json();

        const container = document.getElementById('messages');
        container.innerHTML = '';

        const readMessages = getReadMessages();

        data.forEach((msg, index) => {
            const div = document.createElement('div');
            div.className = 'msg';

            const isRead = readMessages.includes(msg.filename);
            div.style.borderColor = isRead ? 'red' : 'green';

            div.innerHTML = `
                <audio controls src="${msg.url}"></audio><br>
                <span class="date">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${msg.date} | –ò—Å—Ç–æ—á–Ω–∏–∫: ${msg.source || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
            `;

            container.appendChild(div);

            const audio = div.querySelector('audio');

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ –ø–æ–º–µ—Ç–∫–∞
            if (index === 0 && !isRead && isAutoplayEnabled()) {
                audio.play().then(() => {
                    markAsRead(msg.filename);
                    div.style.borderColor = 'red';
                }).catch(err => {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏:", err);
                });
            }

            // –ü—Ä–∏ —Ä—É—á–Ω–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ ‚Äî —Ç–æ–∂–µ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
            audio.addEventListener('play', () => {
                markAsRead(msg.filename);
                div.style.borderColor = 'red';
            });
        });
    }

    // SSE
    const eventSource = new EventSource('/events');
    eventSource.onmessage = function(event) {
        if (event.data === 'new_message') {
            fetchMessages();
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏
    document.getElementById('autoplay-toggle').addEventListener('click', toggleAutoplay);

    // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    updateAutoplayButton();
    fetchMessages();
</script>
</body>
</html>